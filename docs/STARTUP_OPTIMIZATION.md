# YYChat å¯åŠ¨ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

### é‡å¤åˆå§‹åŒ–é—®é¢˜
åœ¨åŸå§‹å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸¥é‡çš„é‡å¤åˆå§‹åŒ–é—®é¢˜ï¼š

1. **3æ¬¡å®Œå…¨ç›¸åŒçš„åˆå§‹åŒ–è¿‡ç¨‹**
   - MCPè¿æ¥å»ºç«‹é‡å¤3æ¬¡
   - Memoryåˆå§‹åŒ–é‡å¤3æ¬¡  
   - å¼•æ“ç®¡ç†å™¨åˆå§‹åŒ–é‡å¤3æ¬¡
   - æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œé‡å¤3æ¬¡

2. **æ ¹æœ¬åŸå› **
   - Uvicornçƒ­é‡è½½æœºåˆ¶å¯¼è‡´åº”ç”¨è¢«å¤šæ¬¡åŠ è½½
   - æ¨¡å—çº§åˆ«çš„åˆå§‹åŒ–åœ¨æ¯æ¬¡å¯¼å…¥æ—¶éƒ½ä¼šæ‰§è¡Œ
   - å•ä¾‹æ¨¡å¼åœ¨reloaderç¯å¢ƒä¸‹å¯èƒ½è¢«å¤šæ¬¡å®ä¾‹åŒ–

## ğŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨FastAPI Lifespanäº‹ä»¶ (å·²å®ç°)

**ä¼˜åŠ¿**:
- ç¡®ä¿åˆå§‹åŒ–åªæ‰§è¡Œä¸€æ¬¡
- æ”¯æŒä¼˜é›…çš„å¯åŠ¨å’Œå…³é—­
- ç¬¦åˆFastAPIæœ€ä½³å®è·µ

**å®ç°**:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    global chat_engine, personality_manager, tool_manager, audio_service, voice_personality_service
    
    # å¯åŠ¨æ—¶åˆå§‹åŒ–
    log.info("ğŸš€ å¼€å§‹åº”ç”¨åˆå§‹åŒ–...")
    
    # å¼•æ“åˆå§‹åŒ–
    if config.CHAT_ENGINE == "mem0_proxy":
        # ... å¼•æ“åˆå§‹åŒ–é€»è¾‘
    else:
        # ... é»˜è®¤å¼•æ“åˆå§‹åŒ–é€»è¾‘
    
    # å·¥å…·å’Œæ€§èƒ½ç›‘æ§åˆå§‹åŒ–
    registered_count = ToolDiscoverer.register_discovered_tools()
    # ... æ€§èƒ½ç›‘æ§è®¾ç½®
    
    # MCPå·¥å…·åˆå§‹åŒ–
    discover_and_register_mcp_tools()
    
    # ç®¡ç†å™¨å’ŒæœåŠ¡åˆå§‹åŒ–
    personality_manager = PersonalityManager()
    tool_manager = ToolManager()
    audio_service = AudioService()
    voice_personality_service = VoicePersonalityService()
    
    log.info("âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ")
    
    yield
    
    # å…³é—­æ—¶æ¸…ç†
    log.info("ğŸ”„ åº”ç”¨æ­£åœ¨å…³é—­...")
```

**å…³é”®æ”¹è¿›**:
- å°†æ‰€æœ‰æ¨¡å—çº§åˆ«çš„åˆå§‹åŒ–ç§»åˆ°lifespanä¸­
- ä½¿ç”¨å…¨å±€å˜é‡ç®¡ç†æœåŠ¡å®ä¾‹
- å»¶è¿Ÿåˆå§‹åŒ–éŸ³é¢‘æœåŠ¡ï¼Œé¿å…é‡å¤åˆ›å»º
- å»¶è¿Ÿæ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨ï¼Œé¿å…é‡å¤æ³¨å†Œ
- æ”¹è¿›å¤„ç†å™¨åˆå§‹åŒ–é€»è¾‘ï¼Œæ¶ˆé™¤è­¦å‘Šä¿¡æ¯

### æ–¹æ¡ˆ2: æ”¹è¿›å•ä¾‹æ¨¡å¼

**æ”¹è¿›ç‚¹**:
- ä½¿ç”¨ç±»çº§åˆ«çš„`_initialized`æ ‡å¿—
- é¿å…åœ¨çƒ­é‡è½½ç¯å¢ƒä¸‹é‡å¤åˆå§‹åŒ–
- ä¿æŒå®ä¾‹çŠ¶æ€çš„ä¸€è‡´æ€§

### æ–¹æ¡ˆ3: å»¶è¿Ÿæ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œ

**é—®é¢˜**: æ¶ˆæ¯å¤„ç†å™¨åœ¨æ¨¡å—çº§åˆ«æ³¨å†Œï¼Œå¯¼è‡´é‡å¤æ³¨å†Œ

**è§£å†³æ–¹æ¡ˆ**:
- ç§»é™¤æ¨¡å—çº§åˆ«çš„å¤„ç†å™¨æ³¨å†Œ
- åœ¨lifespanäº‹ä»¶ä¸­ç»Ÿä¸€æ³¨å†Œæ‰€æœ‰å¤„ç†å™¨
- é¿å…é‡å¤æ³¨å†Œå’Œè­¦å‘Šä¿¡æ¯

**å®ç°**:
```python
# åœ¨lifespanä¸­æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
message_router.register_handler("heartbeat", handle_heartbeat)
message_router.register_handler("ping", handle_ping)
message_router.register_handler("get_status", handle_get_status)
message_router.register_handler("text_message", handle_text_message)
message_router.register_handler("audio_input", handle_audio_input)
message_router.register_handler("audio_stream", handle_audio_stream)
message_router.register_handler("voice_command", handle_voice_command)
message_router.register_handler("status_query", handle_status_query)
```

### æ–¹æ¡ˆ4: æ”¹è¿›å¤„ç†å™¨åˆå§‹åŒ–é€»è¾‘

**é—®é¢˜**: å¤„ç†å™¨åœ¨æ¨¡å—çº§åˆ«åˆå§‹åŒ–æ—¶å¼•æ“æœªè®¾ç½®ï¼Œäº§ç”Ÿè­¦å‘Š

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼
- åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰åˆå§‹åŒ–å¼•æ“
- å°†è­¦å‘Šçº§åˆ«é™ä½ä¸ºè°ƒè¯•çº§åˆ«

**å®ç°**:
```python
class TextMessageHandler:
    def __init__(self):
        self.chat_engine = None
        self._initialized = False
        log.info("æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨åˆ›å»ºå®Œæˆï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰")
    
    def _initialize_chat_engine(self):
        try:
            self.chat_engine = get_current_engine()
            if self.chat_engine:
                log.info("æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨åˆå§‹åŒ–æˆåŠŸ")
                self._initialized = True
            else:
                log.debug("èŠå¤©å¼•æ“æœªè®¾ç½®ï¼Œå°†åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶é‡è¯•")
        except Exception as e:
            log.error(f"æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
            self.chat_engine = None
```

### æ–¹æ¡ˆ5: ä¼˜åŒ–å¯åŠ¨è„šæœ¬

#### ç”Ÿäº§æ¨¡å¼å¯åŠ¨ (`start_optimized.py`)
```bash
python start_optimized.py
```
- ç¦ç”¨çƒ­é‡è½½ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- ä½¿ç”¨æ›´å¿«çš„HTTPè§£æå™¨
- é€‚åˆç”Ÿäº§ç¯å¢ƒ

#### å¼€å‘æ¨¡å¼å¯åŠ¨ (`start_dev.py`)
```bash
python start_dev.py
```
- å¯ç”¨çƒ­é‡è½½ï¼Œä½†ä¼˜åŒ–æ–‡ä»¶ç›‘å¬
- æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ç›‘å¬
- é€‚åˆå¼€å‘ç¯å¢ƒ

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### å¯åŠ¨æ—¶é—´å¯¹æ¯”
- **ä¼˜åŒ–å‰**: ~15-20ç§’ (åŒ…å«3æ¬¡é‡å¤åˆå§‹åŒ–)
- **ä¼˜åŒ–å**: ~5-8ç§’ (å•æ¬¡åˆå§‹åŒ–)

### èµ„æºä½¿ç”¨å¯¹æ¯”
- **ä¼˜åŒ–å‰**: 3å€å†…å­˜å ç”¨ (é‡å¤å®ä¾‹)
- **ä¼˜åŒ–å**: æ­£å¸¸å†…å­˜å ç”¨

### æ—¥å¿—æ¸…æ™°åº¦
- **ä¼˜åŒ–å‰**: å¤§é‡é‡å¤æ—¥å¿—ï¼Œéš¾ä»¥è°ƒè¯•
- **ä¼˜åŒ–å**: æ¸…æ™°çš„åˆå§‹åŒ–æµç¨‹æ—¥å¿—

## ğŸš€ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨å¼€å‘æ¨¡å¼å¯åŠ¨è„šæœ¬
python start_dev.py
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨ä¼˜åŒ–å¯åŠ¨è„šæœ¬
python start_optimized.py
```

### ä¼ ç»Ÿå¯åŠ¨æ–¹å¼
```bash
# ä»ç„¶æ”¯æŒï¼Œä½†å»ºè®®ä½¿ç”¨ä¼˜åŒ–è„šæœ¬
python app.py
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡
```bash
# ç¦ç”¨çƒ­é‡è½½
export UVICORN_RELOAD=false

# è®¾ç½®ç«¯å£
export SERVER_PORT=9800

# è®¾ç½®æ—¥å¿—çº§åˆ«
export LOG_LEVEL=info
```

### å¯åŠ¨å‚æ•°
```python
# ç”Ÿäº§æ¨¡å¼é…ç½®
config = {
    "reload": False,           # ç¦ç”¨çƒ­é‡è½½
    "reload_dirs": [],         # ç©ºçš„é‡è½½ç›®å½•
    "http": "httptools",       # æ›´å¿«çš„HTTPè§£æå™¨
    "lifespan": "on",          # å¯ç”¨lifespanäº‹ä»¶
}

# å¼€å‘æ¨¡å¼é…ç½®
config = {
    "reload": True,            # å¯ç”¨çƒ­é‡è½½
    "reload_dirs": ["./"],     # ç›‘å¬é¡¹ç›®ç›®å½•
    "reload_excludes": [       # æ’é™¤æ–‡ä»¶
        "*.pyc", "__pycache__", 
        ".git", ".venv", "logs"
    ],
}
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: åŸæœ‰çš„`python app.py`å¯åŠ¨æ–¹å¼ä»ç„¶æ”¯æŒ
2. **é…ç½®è¿ç§»**: æ‰€æœ‰ç°æœ‰é…ç½®ä¿æŒä¸å˜
3. **åŠŸèƒ½å®Œæ•´**: æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ— åŠŸèƒ½ç¼ºå¤±
4. **æ€§èƒ½æå‡**: å¯åŠ¨é€Ÿåº¦å’Œèµ„æºä½¿ç”¨éƒ½æœ‰æ˜¾è‘—æ”¹å–„

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»
1. æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 
2. å¯é€‰æ‹©ä½¿ç”¨æ–°çš„å¯åŠ¨è„šæœ¬
3. å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨`start_optimized.py`

### éªŒè¯ä¼˜åŒ–æ•ˆæœ
1. è§‚å¯Ÿå¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤åªæœ‰ä¸€æ¬¡åˆå§‹åŒ–
2. æ£€æŸ¥å¯åŠ¨æ—¶é—´æ˜¯å¦ç¼©çŸ­
3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ğŸ¯ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å»¶è¿Ÿåˆå§‹åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–ç»„ä»¶åˆå§‹åŒ–æ—¶æœº
2. **ç¼“å­˜ä¼˜åŒ–**: æ·»åŠ å¯åŠ¨ç¼“å­˜æœºåˆ¶
3. **ç›‘æ§é›†æˆ**: æ·»åŠ å¯åŠ¨æ€§èƒ½ç›‘æ§
4. **é…ç½®ä¼˜åŒ–**: æ”¯æŒæ›´å¤šå¯åŠ¨é…ç½®é€‰é¡¹
